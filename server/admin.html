<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TripAI Admin Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f0f2f5;--sidebar:#1a1a2e;--sidebar-hover:#16213e;--card:#fff;--gold:#D4A843;--gold-light:#f5e6c8;--text:#333;--text-light:#888;--border:#e0e0e0;--danger:#e74c3c;--success:#27ae60;--info:#3498db}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
/* Login Screen */
.login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);display:flex;align-items:center;justify-content:center;z-index:1000}
.login-box{background:var(--card);border-radius:16px;padding:48px;width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.login-box h1{font-size:28px;margin-bottom:4px;color:var(--sidebar)}
.login-box .brand{color:var(--gold);font-size:14px;margin-bottom:32px;display:block}
.login-box input{width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:10px;font-size:15px;outline:none;transition:border .2s}
.login-box input:focus{border-color:var(--gold)}
.login-box button{width:100%;padding:14px;background:var(--gold);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-top:16px;transition:background .2s}
.login-box button:hover{background:#c49a38}
.login-error{color:var(--danger);font-size:13px;margin-top:12px;display:none}
/* Sidebar */
.sidebar{width:240px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100}
.sidebar-brand{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.1)}
.sidebar-brand h2{font-size:20px;color:var(--gold)}
.sidebar-brand span{font-size:12px;color:rgba(255,255,255,.5)}
.sidebar-nav{flex:1;padding:12px 0}
.sidebar-nav a{display:flex;align-items:center;padding:12px 20px;color:rgba(255,255,255,.7);text-decoration:none;font-size:14px;transition:all .2s;border-left:3px solid transparent;gap:10px}
.sidebar-nav a:hover{background:var(--sidebar-hover);color:#fff}
.sidebar-nav a.active{background:var(--sidebar-hover);color:var(--gold);border-left-color:var(--gold)}
.sidebar-nav a .icon{width:20px;text-align:center;font-size:16px}
.sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.1)}
.sidebar-footer button{width:100%;padding:10px;background:rgba(255,255,255,.1);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;transition:background .2s}
.sidebar-footer button:hover{background:rgba(255,255,255,.2)}
/* Main content */
.main{margin-left:240px;flex:1;padding:24px;min-height:100vh}
.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.main-header h1{font-size:24px;color:var(--sidebar)}
.main-header .refresh-info{font-size:12px;color:var(--text-light)}
/* Tab content */
.tab-content{display:none}
.tab-content.active{display:block}
/* Cards */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.stat-card .label{font-size:12px;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px}
.stat-card .value{font-size:28px;font-weight:700;color:var(--sidebar);margin-top:4px}
.stat-card .sub{font-size:12px;color:var(--gold);margin-top:2px}
.stat-card.gold{border-left:4px solid var(--gold)}
/* Tables */
.table-card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:24px;overflow-x:auto}
.table-card h3{margin-bottom:16px;font-size:16px}
.filters{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filters input,.filters select{padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;outline:none}
.filters input:focus,.filters select:focus{border-color:var(--gold)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 12px;background:#f8f9fa;border-bottom:2px solid var(--border);font-weight:600;color:var(--text-light);font-size:11px;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
td{padding:10px 12px;border-bottom:1px solid #f0f0f0;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tr:hover td{background:#fafafa}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
.badge-guest{background:#e8f4fd;color:#2980b9}
.badge-google{background:#fde8e8;color:#c0392b}
.badge-info{background:var(--gold-light);color:#8B6914}
.badge-error{background:#fde8e8;color:var(--danger)}
.btn{padding:6px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:all .2s}
.btn-danger{background:#fde8e8;color:var(--danger)}
.btn-danger:hover{background:var(--danger);color:#fff}
.btn-primary{background:var(--gold-light);color:#8B6914}
.btn-primary:hover{background:var(--gold);color:#fff}
.btn-sm{padding:4px 10px;font-size:11px}
/* Pagination */
.pagination{display:flex;justify-content:space-between;align-items:center;margin-top:16px;font-size:13px}
.pagination button{padding:6px 16px;border:1px solid var(--border);background:var(--card);border-radius:6px;cursor:pointer;font-size:13px}
.pagination button:disabled{opacity:.4;cursor:default}
.pagination button:not(:disabled):hover{border-color:var(--gold);color:var(--gold)}
/* Charts */
.charts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:20px;margin-bottom:24px}
.chart-card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.chart-card h3{margin-bottom:12px;font-size:15px;color:var(--sidebar)}
.chart-card canvas{max-height:280px}
/* Logs */
.log-entry{padding:10px 14px;border-bottom:1px solid #f0f0f0;font-family:'Courier New',monospace;font-size:12px;display:flex;gap:12px;align-items:baseline}
.log-entry .ts{color:var(--text-light);white-space:nowrap}
.log-entry .method{font-weight:700;min-width:50px}
.log-entry .status{font-weight:700;min-width:32px}
.log-entry .status.s2xx{color:var(--success)}
.log-entry .status.s4xx{color:var(--gold)}
.log-entry .status.s5xx{color:var(--danger)}
.log-entry .url{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.log-entry .time{color:var(--text-light);white-space:nowrap}
/* Server monitor */
.monitor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
.monitor-card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.monitor-card h3{font-size:14px;color:var(--text-light);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
.monitor-item{display:flex;justify-content:space-between;padding:6px 0;font-size:14px}
.monitor-item .label{color:var(--text-light)}
.monitor-item .val{font-weight:600}
.progress-bar{height:8px;background:#eee;border-radius:4px;margin-top:4px;overflow:hidden}
.progress-bar .fill{height:100%;border-radius:4px;transition:width .3s}
.fill-cpu{background:var(--info)}
.fill-ram{background:var(--gold)}
.fill-disk{background:var(--success)}
/* Detail modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border-radius:16px;padding:32px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;position:relative}
.modal-close{position:absolute;top:12px;right:16px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-light)}
.modal h2{margin-bottom:16px;padding-right:32px}
.modal img{max-width:100%;border-radius:8px;margin-bottom:16px}
.modal .detail-row{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:14px}
.modal .detail-row .dlabel{color:var(--text-light);min-width:120px}
/* Contact message */
.msg-card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:12px}
.msg-card .msg-header{display:flex;justify-content:space-between;margin-bottom:8px}
.msg-card .msg-topic{font-weight:600;color:var(--gold)}
.msg-card .msg-date{font-size:12px;color:var(--text-light)}
.msg-card .msg-body{font-size:14px;line-height:1.6;white-space:pre-wrap}
.msg-card img{max-width:300px;border-radius:8px;margin-top:12px;cursor:pointer}
/* Expand row */
.expand-row{display:none}
.expand-row.open{display:table-row}
.expand-row td{padding:12px 20px;background:#f8f9fa}
.expand-content{font-size:13px}
.expand-content table{margin-top:8px;width:auto}
.expand-content td,.expand-content th{padding:6px 10px}
/* Hamburger button */
.hamburger{display:none;position:fixed;top:12px;left:12px;z-index:150;background:var(--sidebar);color:var(--gold);border:none;border-radius:8px;width:40px;height:40px;font-size:22px;cursor:pointer;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99}
.sidebar-overlay.open{display:block}
/* Responsive — Tablet (<=1024px) */
@media(max-width:1024px){
.stats-grid{grid-template-columns:repeat(2,1fr)}
.charts-grid{grid-template-columns:1fr}
.monitor-grid{grid-template-columns:repeat(2,1fr)}
}
/* Responsive — Small tablet / large phone (<=768px) */
@media(max-width:768px){
.hamburger{display:flex}
.sidebar{transform:translateX(-100%);transition:transform .3s ease;z-index:110}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0;padding:16px;padding-top:60px}
.main-header h1{font-size:20px}
.stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}
.stat-card{padding:14px}
.stat-card .value{font-size:22px}
.charts-grid{grid-template-columns:1fr;gap:14px}
.monitor-grid{grid-template-columns:1fr;gap:12px}
.filters{flex-direction:column;align-items:stretch}
.filters input,.filters select{width:100%!important}
.table-card{padding:12px}
table{font-size:12px}
th,td{padding:8px 6px}
.btn-sm{padding:3px 6px;font-size:10px}
.pagination{flex-direction:column;gap:8px;align-items:center}
.log-entry{flex-wrap:wrap;gap:6px;font-size:11px}
.log-entry .ts{width:100%}
.log-entry .url{width:100%;min-width:0}
.modal{width:95%;padding:20px;max-height:90vh;border-radius:12px}
.modal h2{font-size:18px}
.modal .detail-row{flex-direction:column;gap:2px}
.modal .detail-row .dlabel{min-width:unset;font-weight:600}
.msg-card img{max-width:100%}
.login-box{width:90%;padding:32px 24px}
}
/* Responsive — Phone (<=480px) */
@media(max-width:480px){
.stats-grid{grid-template-columns:1fr;gap:8px}
.stat-card{padding:12px;display:flex;align-items:center;gap:12px}
.stat-card .label{font-size:11px;margin-bottom:0}
.stat-card .value{font-size:20px;margin-top:0}
.stat-card .sub{display:none}
.stat-card .label{order:1;flex:1}
.stat-card .value{order:2}
.main{padding:10px;padding-top:56px}
.main-header{margin-bottom:14px}
.main-header h1{font-size:18px}
.chart-card{padding:12px}
.chart-card h3{font-size:13px}
table{font-size:11px}
th,td{padding:6px 4px}
.log-entry{font-size:10px;padding:8px 10px}
.modal{padding:16px;border-radius:10px}
.login-box{padding:24px 20px}
.login-box h1{font-size:22px}
.login-box input{padding:12px}
.login-box button{padding:12px}
}
/* Table responsive: hide less important columns on small screens */
@media(max-width:768px){
.hide-mobile{display:none}
}
.hidden{display:none!important}
.loading{text-align:center;padding:40px;color:var(--text-light)}
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <h1>TripAI</h1>
    <span class="brand">Admin Dashboard</span>
    <input type="password" id="loginPassword" placeholder="Enter admin password" autofocus>
    <button onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError">Invalid password. Please try again.</div>
  </div>
</div>

<!-- Hamburger button (mobile) -->
<button class="hamburger" id="hamburgerBtn" onclick="toggleSidebar()">&#9776;</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <h2>TripAI</h2>
    <span>Admin Dashboard</span>
  </div>
  <nav class="sidebar-nav">
    <a href="#" data-tab="overview" class="active"><span class="icon">&#9776;</span><span>Overview</span></a>
    <a href="#" data-tab="server"><span class="icon">&#9881;</span><span>Server</span></a>
    <a href="#" data-tab="users"><span class="icon">&#9787;</span><span>Users</span></a>
    <a href="#" data-tab="landmarks"><span class="icon">&#9962;</span><span>Landmarks</span></a>
    <a href="#" data-tab="analytics"><span class="icon">&#9733;</span><span>Analytics</span></a>
    <a href="#" data-tab="logs"><span class="icon">&#9998;</span><span>Logs</span></a>
    <a href="#" data-tab="contacts"><span class="icon">&#9993;</span><span>Contacts</span></a>
    <a href="#" data-tab="database"><span class="icon">&#9735;</span><span>Database</span></a>
  </nav>
  <div class="sidebar-footer">
    <button onclick="doLogout()">Logout</button>
  </div>
</div>

<!-- Main Content -->
<div class="main" id="mainContent">

  <!-- OVERVIEW TAB -->
  <div class="tab-content active" id="tab-overview">
    <div class="main-header"><h1>Overview</h1></div>
    <div class="stats-grid" id="overviewStats"></div>
  </div>

  <!-- SERVER TAB -->
  <div class="tab-content" id="tab-server">
    <div class="main-header">
      <h1>Server Monitor</h1>
      <span class="refresh-info">Auto-refreshes every 5s</span>
    </div>
    <div class="monitor-grid" id="serverMonitor"></div>
  </div>

  <!-- USERS TAB -->
  <div class="tab-content" id="tab-users">
    <div class="main-header"><h1>Users</h1></div>
    <div class="table-card">
      <div class="filters">
        <input type="text" id="userSearch" placeholder="Search name or email..." style="width:220px">
        <select id="userAuthFilter">
          <option value="">All Types</option>
          <option value="guest">Guest</option>
          <option value="google">Google</option>
        </select>
        <button class="btn btn-primary" onclick="loadUsers()">Search</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th class="hide-mobile">Email</th><th>Type</th><th class="hide-mobile">Device ID</th><th class="hide-mobile">Lang</th><th>Landmarks</th><th class="hide-mobile">Registered</th><th class="hide-mobile">Last Login</th><th></th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
      <div class="pagination" id="usersPagination"></div>
    </div>
  </div>

  <!-- LANDMARKS TAB -->
  <div class="tab-content" id="tab-landmarks">
    <div class="main-header"><h1>Landmarks</h1></div>
    <div class="table-card">
      <div class="filters">
        <input type="text" id="landmarkSearch" placeholder="Search landmark name..." style="width:220px">
        <select id="landmarkLangFilter">
          <option value="">All Languages</option>
          <option value="en">English</option>
          <option value="ru">Russian</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="pt">Portuguese</option>
        </select>
        <select id="landmarkSavedFilter">
          <option value="">All</option>
          <option value="1">Saved</option>
          <option value="0">Not Saved</option>
        </select>
        <button class="btn btn-primary" onclick="loadLandmarks()">Search</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Image</th><th>Name</th><th class="hide-mobile">Size</th><th class="hide-mobile">Location</th><th class="hide-mobile">User</th><th class="hide-mobile">Lang</th><th class="hide-mobile">Rating</th><th class="hide-mobile">Saved</th><th class="hide-mobile">Tokens</th><th class="hide-mobile">Date</th><th></th>
          </tr>
        </thead>
        <tbody id="landmarksTable"></tbody>
      </table>
      <div class="pagination" id="landmarksPagination"></div>
    </div>
  </div>

  <!-- ANALYTICS TAB -->
  <div class="tab-content" id="tab-analytics">
    <div class="main-header"><h1>Analytics</h1></div>
    <div class="charts-grid">
      <div class="chart-card"><h3>User Registrations (Last 30 Days)</h3><canvas id="chartRegistrations"></canvas></div>
      <div class="chart-card"><h3>Landmarks Analyzed (Last 30 Days)</h3><canvas id="chartLandmarks"></canvas></div>
      <div class="chart-card"><h3>Language Distribution</h3><canvas id="chartLanguages"></canvas></div>
      <div class="chart-card"><h3>Auth Type Distribution</h3><canvas id="chartAuth"></canvas></div>
    </div>
    <div class="stats-grid">
      <div class="table-card" style="grid-column:span 1">
        <h3>Top 10 Rated Landmarks</h3>
        <table>
          <thead><tr><th>Name</th><th>Location</th><th>Rating</th></tr></thead>
          <tbody id="topRatedTable"></tbody>
        </table>
      </div>
      <div class="table-card" style="grid-column:span 1">
        <h3>Most Active Users</h3>
        <table>
          <thead><tr><th>Name</th><th>Type</th><th>Landmarks</th></tr></thead>
          <tbody id="mostActiveTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LOGS TAB -->
  <div class="tab-content" id="tab-logs">
    <div class="main-header"><h1>Logs & Errors</h1></div>
    <div class="table-card">
      <div class="filters">
        <select id="logLevelFilter">
          <option value="">All Levels</option>
          <option value="info">Info</option>
          <option value="error">Error</option>
        </select>
        <input type="text" id="logEndpointFilter" placeholder="Filter by endpoint..." style="width:220px">
        <button class="btn btn-primary" onclick="loadLogs()">Filter</button>
      </div>
      <div id="logsContainer" style="max-height:600px;overflow-y:auto"></div>
    </div>
  </div>

  <!-- CONTACTS TAB -->
  <div class="tab-content" id="tab-contacts">
    <div class="main-header"><h1>Contact Messages</h1></div>
    <div class="filters" style="margin-bottom:16px">
      <input type="text" id="contactTopicFilter" placeholder="Filter by topic...">
      <button class="btn btn-primary" onclick="loadContacts()">Filter</button>
    </div>
    <div id="contactsContainer"></div>
  </div>

  <!-- DATABASE TAB -->
  <div class="tab-content" id="tab-database">
    <div class="main-header"><h1>Database</h1></div>
    <div class="monitor-grid" id="databaseInfo"></div>
  </div>

</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const API = window.location.origin;
let token = localStorage.getItem("admin_token");
let serverInterval = null;
let currentUsersPage = 1;
let currentLandmarksPage = 1;
const LIMIT = 50;

// Charts stored for destroy/recreate
let charts = {};

// ── Auth ──────────────────────────────────────────────────────
function checkAuth() {
  if (token) {
    document.getElementById("loginScreen").style.display = "none";
    loadTab("overview");
  }
}

async function doLogin() {
  const pw = document.getElementById("loginPassword").value;
  try {
    const r = await fetch(API + "/api/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pw }),
    });
    if (!r.ok) throw new Error();
    const data = await r.json();
    token = data.token;
    localStorage.setItem("admin_token", token);
    document.getElementById("loginScreen").style.display = "none";
    loadTab("overview");
  } catch {
    const el = document.getElementById("loginError");
    el.style.display = "block";
    setTimeout(() => el.style.display = "none", 3000);
  }
}

document.getElementById("loginPassword").addEventListener("keydown", (e) => {
  if (e.key === "Enter") doLogin();
});

function doLogout() {
  token = null;
  localStorage.removeItem("admin_token");
  if (serverInterval) clearInterval(serverInterval);
  document.getElementById("loginScreen").style.display = "flex";
}

function authHeaders() {
  return { Authorization: "Bearer " + token, "Content-Type": "application/json" };
}

async function apiFetch(path) {
  const r = await fetch(API + path, { headers: authHeaders() });
  if (r.status === 401) { doLogout(); throw new Error("Unauthorized"); }
  return r.json();
}

// ── Sidebar toggle (mobile) ───────────────────────────────────
function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("open");
  document.getElementById("sidebarOverlay").classList.toggle("open");
}

// ── Tabs ──────────────────────────────────────────────────────
document.querySelectorAll(".sidebar-nav a").forEach((a) => {
  a.addEventListener("click", (e) => {
    e.preventDefault();
    const tab = a.dataset.tab;
    document.querySelectorAll(".sidebar-nav a").forEach((x) => x.classList.remove("active"));
    a.classList.add("active");
    document.querySelectorAll(".tab-content").forEach((x) => x.classList.remove("active"));
    document.getElementById("tab-" + tab).classList.add("active");
    // Close sidebar on mobile after selecting tab
    document.getElementById("sidebar").classList.remove("open");
    document.getElementById("sidebarOverlay").classList.remove("open");
    loadTab(tab);
  });
});

function loadTab(tab) {
  if (serverInterval) { clearInterval(serverInterval); serverInterval = null; }
  switch (tab) {
    case "overview": loadOverview(); break;
    case "server": loadServer(); serverInterval = setInterval(loadServer, 5000); break;
    case "users": loadUsers(); break;
    case "landmarks": loadLandmarks(); break;
    case "analytics": loadAnalytics(); break;
    case "logs": loadLogs(); break;
    case "contacts": loadContacts(); break;
    case "database": loadDatabase(); break;
  }
}

// ── Helpers ───────────────────────────────────────────────────
function fmtDate(d) { if (!d) return "-"; return new Date(d).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" }); }
function fmtDateTime(d) { if (!d) return "-"; return new Date(d).toLocaleString("en-US", { month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit" }); }
function fmtBytes(b) { if (b < 1024) return b + " B"; if (b < 1048576) return (b/1024).toFixed(1) + " KB"; if (b < 1073741824) return (b/1048576).toFixed(1) + " MB"; return (b/1073741824).toFixed(2) + " GB"; }
function fmtUptime(s) { const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60); return (d?d+"d ":"")+(h?h+"h ":"")+m+"m"; }
function stars(n) { return "&#9733;".repeat(n) + "&#9734;".repeat(5-n); }
function esc(s) { if (!s) return ""; const d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

// ── Overview ─────────────────────────────────────────────────
async function loadOverview() {
  try {
    const d = await apiFetch("/api/admin/overview");
    document.getElementById("overviewStats").innerHTML = `
      <div class="stat-card gold"><div class="label">Total Users</div><div class="value">${d.totalUsers}</div><div class="sub">${d.guestUsers} guests, ${d.googleUsers} google</div></div>
      <div class="stat-card gold"><div class="label">Total Landmarks</div><div class="value">${d.totalLandmarks}</div><div class="sub">${d.savedLandmarks} saved</div></div>
      <div class="stat-card"><div class="label">Average Rating</div><div class="value">${d.avgRating}</div><div class="sub">out of 5</div></div>
      <div class="stat-card"><div class="label">Today's Users</div><div class="value">${d.todayUsers}</div><div class="sub">new registrations</div></div>
      <div class="stat-card"><div class="label">Today's Landmarks</div><div class="value">${d.todayLandmarks}</div><div class="sub">analyzed today</div></div>
      <div class="stat-card"><div class="label">Server Uptime</div><div class="value">${fmtUptime(d.uptimeSeconds)}</div><div class="sub">${d.memoryMB} MB heap</div></div>
    `;
  } catch(e) { console.error(e); }
}

// ── Server Monitor ───────────────────────────────────────────
async function loadServer() {
  try {
    const d = await apiFetch("/api/admin/server");
    const ramPct = ((d.ram.used / d.ram.total) * 100).toFixed(1);
    const heapPct = ((d.nodeMemory.heapUsed / d.nodeMemory.heapTotal) * 100).toFixed(1);
    document.getElementById("serverMonitor").innerHTML = `
      <div class="monitor-card">
        <h3>CPU</h3>
        <div class="monitor-item"><span class="label">Usage</span><span class="val">${d.cpu.usage}%</span></div>
        <div class="progress-bar"><div class="fill fill-cpu" style="width:${d.cpu.usage}%"></div></div>
        <div class="monitor-item"><span class="label">Cores</span><span class="val">${d.cpu.cores}</span></div>
      </div>
      <div class="monitor-card">
        <h3>RAM</h3>
        <div class="monitor-item"><span class="label">Used / Total</span><span class="val">${fmtBytes(d.ram.used)} / ${fmtBytes(d.ram.total)}</span></div>
        <div class="progress-bar"><div class="fill fill-ram" style="width:${ramPct}%"></div></div>
        <div class="monitor-item"><span class="label">Free</span><span class="val">${fmtBytes(d.ram.free)}</span></div>
      </div>
      <div class="monitor-card">
        <h3>Node.js Memory</h3>
        <div class="monitor-item"><span class="label">Heap Used / Total</span><span class="val">${fmtBytes(d.nodeMemory.heapUsed)} / ${fmtBytes(d.nodeMemory.heapTotal)}</span></div>
        <div class="progress-bar"><div class="fill fill-cpu" style="width:${heapPct}%"></div></div>
        <div class="monitor-item"><span class="label">RSS</span><span class="val">${fmtBytes(d.nodeMemory.rss)}</span></div>
        <div class="monitor-item"><span class="label">External</span><span class="val">${fmtBytes(d.nodeMemory.external)}</span></div>
      </div>
      <div class="monitor-card">
        <h3>Uptime</h3>
        <div class="monitor-item"><span class="label">Server</span><span class="val">${fmtUptime(d.uptime.server)}</span></div>
        <div class="monitor-item"><span class="label">System</span><span class="val">${fmtUptime(d.uptime.system)}</span></div>
        <div class="monitor-item"><span class="label">Node.js</span><span class="val">${d.nodeVersion}</span></div>
        <div class="monitor-item"><span class="label">Platform</span><span class="val">${d.platform}</span></div>
        <div class="monitor-item"><span class="label">Hostname</span><span class="val">${esc(d.hostname)}</span></div>
      </div>
      <div class="monitor-card">
        <h3>Uploads</h3>
        <div class="monitor-item"><span class="label">Files</span><span class="val">${d.uploads.count}</span></div>
        <div class="monitor-item"><span class="label">Size</span><span class="val">${fmtBytes(d.uploads.size)}</span></div>
      </div>
      <div class="monitor-card">
        <h3>DB Pool</h3>
        <div class="monitor-item"><span class="label">Total</span><span class="val">${d.pool.total}</span></div>
        <div class="monitor-item"><span class="label">Idle</span><span class="val">${d.pool.idle}</span></div>
        <div class="monitor-item"><span class="label">Waiting</span><span class="val">${d.pool.waiting}</span></div>
      </div>
    `;
  } catch(e) { console.error(e); }
}

// ── Users ────────────────────────────────────────────────────
async function loadUsers(page) {
  if (page) currentUsersPage = page;
  const search = document.getElementById("userSearch").value;
  const auth_type = document.getElementById("userAuthFilter").value;
  let url = `/api/admin/users?page=${currentUsersPage}&limit=${LIMIT}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (auth_type) url += `&auth_type=${auth_type}`;
  try {
    const d = await apiFetch(url);
    const tbody = document.getElementById("usersTable");
    tbody.innerHTML = d.users.map((u) => `
      <tr>
        <td>${u.id}</td>
        <td>${esc(u.display_name)}</td>
        <td class="hide-mobile">${esc(u.email) || "-"}</td>
        <td><span class="badge badge-${u.auth_type}">${u.auth_type}</span></td>
        <td class="hide-mobile" title="${esc(u.device_id)}">${u.device_id ? esc(u.device_id).substring(0,16)+"..." : "-"}</td>
        <td class="hide-mobile">${u.language || "en"}</td>
        <td>${u.landmarks_count}</td>
        <td class="hide-mobile">${fmtDate(u.created_at)}</td>
        <td class="hide-mobile">${fmtDate(u.last_login_at)}</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="viewUserLandmarks(${u.id},'${esc(u.display_name)}')">View</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">Delete</button>
        </td>
      </tr>
    `).join("");
    const totalPages = Math.ceil(d.total / LIMIT);
    document.getElementById("usersPagination").innerHTML = `
      <span>Page ${currentUsersPage} of ${totalPages} (${d.total} total)</span>
      <div>
        <button ${currentUsersPage<=1?"disabled":""} onclick="loadUsers(${currentUsersPage-1})">Prev</button>
        <button ${currentUsersPage>=totalPages?"disabled":""} onclick="loadUsers(${currentUsersPage+1})">Next</button>
      </div>
    `;
  } catch(e) { console.error(e); }
}

async function viewUserLandmarks(userId, name) {
  try {
    const data = await apiFetch(`/api/admin/users/${userId}/landmarks`);
    let html = `<h2>${esc(name)}'s Landmarks (${data.length})</h2>`;
    if (data.length === 0) { html += "<p>No landmarks found.</p>"; }
    else {
      html += `<table><thead><tr><th>ID</th><th>Name</th><th>Lang</th><th>Rating</th><th>Saved</th><th>Date</th></tr></thead><tbody>`;
      data.forEach((l) => {
        html += `<tr><td>${l.id}</td><td>${esc(l.name)}</td><td>${l.language||"en"}</td><td>${stars(l.rating)}</td><td>${l.is_saved?"Yes":"No"}</td><td>${fmtDate(l.created_at)}</td></tr>`;
      });
      html += `</tbody></table>`;
    }
    openModal(html);
  } catch(e) { console.error(e); }
}

async function deleteUser(id) {
  if (!confirm("Delete user #" + id + " and all their landmarks? This cannot be undone.")) return;
  try {
    await fetch(API + `/api/admin/users/${id}`, { method: "DELETE", headers: authHeaders() });
    loadUsers();
  } catch(e) { console.error(e); }
}

// ── Landmarks ────────────────────────────────────────────────
async function loadLandmarks(page) {
  if (page) currentLandmarksPage = page;
  const search = document.getElementById("landmarkSearch").value;
  const language = document.getElementById("landmarkLangFilter").value;
  const saved = document.getElementById("landmarkSavedFilter").value;
  let url = `/api/admin/landmarks?page=${currentLandmarksPage}&limit=${LIMIT}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (language) url += `&language=${language}`;
  if (saved !== "") url += `&saved=${saved}`;
  try {
    const d = await apiFetch(url);
    const tbody = document.getElementById("landmarksTable");
    tbody.innerHTML = d.landmarks.map((l) => `
      <tr>
        <td>${l.id}</td>
        <td>${l.image_filename ? `<img src="${API}/api/uploads/${l.image_filename}" style="width:40px;height:40px;object-fit:cover;border-radius:6px" onerror="this.style.display='none'">` : "-"}</td>
        <td>${esc(l.name)}</td>
        <td class="hide-mobile">${l.image_size ? fmtBytes(l.image_size) : "-"}</td>
        <td class="hide-mobile">${esc(l.location)}</td>
        <td class="hide-mobile">${esc(l.user_name) || "ID:"+l.user_id}</td>
        <td class="hide-mobile">${l.language||"en"}</td>
        <td class="hide-mobile">${stars(l.rating||0)}</td>
        <td class="hide-mobile">${l.is_saved ? '<span class="badge badge-info">Saved</span>' : "-"}</td>
        <td class="hide-mobile">${l.tokens_total || 0}</td>
        <td class="hide-mobile">${fmtDate(l.created_at)}</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="viewLandmark(${l.id})">View</button>
          <button class="btn btn-danger btn-sm" onclick="deleteLandmark(${l.id})">Delete</button>
        </td>
      </tr>
    `).join("");
    const totalPages = Math.ceil(d.total / LIMIT);
    document.getElementById("landmarksPagination").innerHTML = `
      <span>Page ${currentLandmarksPage} of ${totalPages} (${d.total} total)</span>
      <div>
        <button ${currentLandmarksPage<=1?"disabled":""} onclick="loadLandmarks(${currentLandmarksPage-1})">Prev</button>
        <button ${currentLandmarksPage>=totalPages?"disabled":""} onclick="loadLandmarks(${currentLandmarksPage+1})">Next</button>
      </div>
    `;
  } catch(e) { console.error(e); }
}

async function viewLandmark(id) {
  try {
    const l = await apiFetch(`/api/admin/landmarks/${id}`);
    let html = `<h2>${esc(l.name)}</h2>`;
    if (l.image_filename) html += `<img src="${API}/api/uploads/${l.image_filename}" onerror="this.style.display='none'">`;
    html += `
      <div class="detail-row"><span class="dlabel">ID</span><span>${l.id}</span></div>
      <div class="detail-row"><span class="dlabel">Image Size</span><span>${l.image_size ? fmtBytes(l.image_size) : "-"}</span></div>
      <div class="detail-row"><span class="dlabel">Location</span><span>${esc(l.location)}</span></div>
      <div class="detail-row"><span class="dlabel">Year Built</span><span>${esc(l.year_built)}</span></div>
      <div class="detail-row"><span class="dlabel">Status</span><span>${esc(l.status)}</span></div>
      <div class="detail-row"><span class="dlabel">Architect</span><span>${esc(l.architect)}</span></div>
      <div class="detail-row"><span class="dlabel">Capacity</span><span>${esc(l.capacity)}</span></div>
      <div class="detail-row"><span class="dlabel">User</span><span>${esc(l.user_name) || "ID:"+l.user_id}</span></div>
      <div class="detail-row"><span class="dlabel">Language</span><span>${l.language||"en"}</span></div>
      <div class="detail-row"><span class="dlabel">Rating</span><span>${stars(l.rating||0)}</span></div>
      <div class="detail-row"><span class="dlabel">Saved</span><span>${l.is_saved?"Yes":"No"}</span></div>
      <div class="detail-row"><span class="dlabel">Coordinates</span><span>${l.latitude||"-"}, ${l.longitude||"-"}</span></div>
      <div class="detail-row"><span class="dlabel">Tokens</span><span>In: ${l.tokens_input||0} &nbsp;|&nbsp; Out: ${l.tokens_output||0} &nbsp;|&nbsp; Total: ${l.tokens_total||0}</span></div>
      <div class="detail-row"><span class="dlabel">Created</span><span>${fmtDateTime(l.created_at)}</span></div>
      <h3 style="margin:16px 0 8px">Narrative</h3>
      <p style="font-size:14px;line-height:1.6;margin-bottom:8px">${esc(l.narrative_p1)}</p>
      <blockquote style="border-left:3px solid var(--gold);padding-left:12px;margin:8px 0;font-style:italic;color:var(--text-light)">${esc(l.narrative_quote)}</blockquote>
      <p style="font-size:14px;line-height:1.6">${esc(l.narrative_p2)}</p>
      <h3 style="margin:16px 0 8px">Nearby Places</h3>
      <div class="detail-row"><span class="dlabel">${esc(l.nearby1_category)}</span><span>${esc(l.nearby1_name)}</span></div>
      <div class="detail-row"><span class="dlabel">${esc(l.nearby2_category)}</span><span>${esc(l.nearby2_name)}</span></div>
      <div class="detail-row"><span class="dlabel">${esc(l.nearby3_category)}</span><span>${esc(l.nearby3_name)}</span></div>
    `;
    openModal(html);
  } catch(e) { console.error(e); }
}

async function deleteLandmark(id) {
  if (!confirm("Delete landmark #" + id + "? This cannot be undone.")) return;
  try {
    await fetch(API + `/api/admin/landmarks/${id}`, { method: "DELETE", headers: authHeaders() });
    loadLandmarks();
  } catch(e) { console.error(e); }
}

// ── Analytics ────────────────────────────────────────────────
async function loadAnalytics() {
  try {
    const d = await apiFetch("/api/admin/analytics");

    // Destroy old charts
    Object.values(charts).forEach((c) => c.destroy());
    charts = {};

    // Registrations line chart
    charts.reg = new Chart(document.getElementById("chartRegistrations"), {
      type: "line",
      data: {
        labels: d.registrationsDaily.map((r) => new Date(r.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})),
        datasets: [{ label: "Users", data: d.registrationsDaily.map((r) => parseInt(r.count)), borderColor: "#D4A843", backgroundColor: "rgba(212,168,67,.1)", fill: true, tension: .3 }],
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } },
    });

    // Landmarks bar chart
    charts.lm = new Chart(document.getElementById("chartLandmarks"), {
      type: "bar",
      data: {
        labels: d.landmarksDaily.map((r) => new Date(r.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})),
        datasets: [{ label: "Landmarks", data: d.landmarksDaily.map((r) => parseInt(r.count)), backgroundColor: "rgba(212,168,67,.7)", borderRadius: 4 }],
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } },
    });

    // Language pie
    charts.lang = new Chart(document.getElementById("chartLanguages"), {
      type: "doughnut",
      data: {
        labels: d.languageDistribution.map((r) => r.language.toUpperCase()),
        datasets: [{ data: d.languageDistribution.map((r) => parseInt(r.count)), backgroundColor: ["#D4A843","#3498db","#e74c3c","#27ae60","#9b59b6","#e67e22","#1abc9c","#34495e"] }],
      },
      options: { responsive: true },
    });

    // Auth pie
    charts.auth = new Chart(document.getElementById("chartAuth"), {
      type: "doughnut",
      data: {
        labels: d.authDistribution.map((r) => r.auth_type),
        datasets: [{ data: d.authDistribution.map((r) => parseInt(r.count)), backgroundColor: ["#3498db","#e74c3c","#27ae60"] }],
      },
      options: { responsive: true },
    });

    // Top rated table
    document.getElementById("topRatedTable").innerHTML = d.topRated.map((l) =>
      `<tr><td>${esc(l.name)}</td><td>${esc(l.location)}</td><td>${stars(l.rating)}</td></tr>`
    ).join("");

    // Most active table
    document.getElementById("mostActiveTable").innerHTML = d.mostActive.map((u) =>
      `<tr><td>${esc(u.display_name)}</td><td><span class="badge badge-${u.auth_type}">${u.auth_type}</span></td><td>${u.landmarks_count}</td></tr>`
    ).join("");
  } catch(e) { console.error(e); }
}

// ── Logs ─────────────────────────────────────────────────────
async function loadLogs() {
  const level = document.getElementById("logLevelFilter").value;
  const endpoint = document.getElementById("logEndpointFilter").value;
  let url = "/api/admin/logs?";
  if (level) url += `level=${level}&`;
  if (endpoint) url += `endpoint=${encodeURIComponent(endpoint)}&`;
  try {
    const logs = await apiFetch(url);
    const container = document.getElementById("logsContainer");
    if (logs.length === 0) { container.innerHTML = '<div class="loading">No logs recorded yet.</div>'; return; }
    container.innerHTML = logs.map((l) => {
      const sc = l.status >= 500 ? "s5xx" : l.status >= 400 ? "s4xx" : "s2xx";
      return `<div class="log-entry">
        <span class="ts">${fmtDateTime(l.timestamp)}</span>
        <span class="method">${l.method}</span>
        <span class="status ${sc}">${l.status || "-"}</span>
        <span class="url">${esc(l.url)}</span>
        <span class="time">${l.responseTime !== null ? l.responseTime + "ms" : "-"}</span>
      </div>`;
    }).join("");
  } catch(e) { console.error(e); }
}

// ── Contacts ─────────────────────────────────────────────────
async function loadContacts() {
  const topic = document.getElementById("contactTopicFilter").value;
  let url = "/api/admin/contacts?";
  if (topic) url += `topic=${encodeURIComponent(topic)}`;
  try {
    const msgs = await apiFetch(url);
    const container = document.getElementById("contactsContainer");
    if (msgs.length === 0) { container.innerHTML = '<div class="loading">No contact messages yet.</div>'; return; }
    container.innerHTML = msgs.map((m) => `
      <div class="msg-card">
        <div class="msg-header">
          <span class="msg-topic">${esc(m.topic)}</span>
          <span class="msg-date">${fmtDateTime(m.created_at)}</span>
        </div>
        <div class="msg-body">${esc(m.message)}</div>
        ${m.screenshot_filename ? `<img src="${API}/api/uploads/${m.screenshot_filename}" onclick="window.open(this.src,'_blank')" onerror="this.style.display='none'">` : ""}
      </div>
    `).join("");
  } catch(e) { console.error(e); }
}

// ── Database ─────────────────────────────────────────────────
async function loadDatabase() {
  try {
    const d = await apiFetch("/api/admin/database");
    document.getElementById("databaseInfo").innerHTML = `
      <div class="monitor-card">
        <h3>Table Row Counts</h3>
        ${Object.entries(d.tables).map(([t,c]) => `<div class="monitor-item"><span class="label">${t}</span><span class="val">${c}</span></div>`).join("")}
      </div>
      <div class="monitor-card">
        <h3>Connection Pool</h3>
        <div class="monitor-item"><span class="label">Total connections</span><span class="val">${d.pool.total}</span></div>
        <div class="monitor-item"><span class="label">Idle</span><span class="val">${d.pool.idle}</span></div>
        <div class="monitor-item"><span class="label">Waiting</span><span class="val">${d.pool.waiting}</span></div>
      </div>
      <div class="monitor-card">
        <h3>Uploads Folder</h3>
        <div class="monitor-item"><span class="label">Files</span><span class="val">${d.uploads.count}</span></div>
        <div class="monitor-item"><span class="label">Total Size</span><span class="val">${fmtBytes(d.uploads.size)}</span></div>
      </div>
    `;
  } catch(e) { console.error(e); }
}

// ── Modal ────────────────────────────────────────────────────
function openModal(html) {
  document.getElementById("modalBody").innerHTML = html;
  document.getElementById("modalOverlay").classList.add("open");
}
function closeModal() {
  document.getElementById("modalOverlay").classList.remove("open");
}
document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

// ── Init ─────────────────────────────────────────────────────
checkAuth();
</script>
</body>
</html>
